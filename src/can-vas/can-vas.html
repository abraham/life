<link rel="import" href="../../bower_components/polymer/polymer.html">

<script src='../../bower_components/three.js/build/three.min.js'></script>

<dom-module id="can-vas">
  <template>
    <style>
      :host {
        display: block;
      }

      #canvas {
        width: 100%;
      }

      :host.light-mode {
        background-color: white;
      }

      :host.dark-mode {
        background-color: black;
      }
    </style>
  </template>

  <script>
    Polymer({

      is: 'can-vas',

      properties: {
        triggerRender: false,
        settings: Object,
        colors: {
          type: Object,
          notify: true,
          observer: '_onColorsChanged'
        },
        renderer: {
          type: Object,
          computed: '_computeRenderer(triggerRender)'
        },
        cells: {
          type: Object,
          value: () => { return {}; }
        },
        scene: {
          type: Object,
          value: new THREE.Scene()
        },
        grid: {
          type: Object,
          value: new THREE.Object3D()
        },
        axes: {
          type: Object,
          // value: new THREE.Object3D()
          computed: '_computeAxes(scene, length)'
        },
        camera: {
          type: Object,
          value: () => {
            var camera = new THREE.PerspectiveCamera(90, window.innerWidth / window.innerHeight, 1, 1000);
            camera.position.set(30, 30, 120);
            return camera;
          }
        },
        controls: {
          type: Object,
          computed: '_computeControls(camera, renderer)'
        },
        length: { // TODO: Remove and use settings.size
          type: Number,
          value: 30
        }
      },

      listeners: {},

      _computeRenderer: function() {
        console.log('_computeRenderer');
        var renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        this.appendChild(renderer.domElement);
        return renderer;
      },
      _computeControls: function(camera, renderer) {
        return new THREE.OrbitControls(this.camera, this.renderer.domElement);
      },
      _computeAxes: function(scene, length) {
        console.log('_computeAxes');
        var axes = new THREE.Object3D();
        var center = new THREE.Vector3(0, 0, 0);
        var color = 0x9E9E9E;
        // TODO: simplify to three lines
        var positions = [
          [length, 0, 0],
          [0 - length, 0, 0],
          [0, length, 0],
          [0, 0 - length, 0],
          [0, 0, length],
          [0, 0, 0 - length]
        ];

        positions.forEach((position) => {
          var geom = new THREE.Geometry();
          var mat = new THREE.LineBasicMaterial({ linewidth: 2, color: color });
          var end = new THREE.Vector3(position[0], position[1], position[3]);

          geom.vertices.push(center.clone());
          geom.vertices.push(end.clone());

          axes.add(new THREE.Line(geom, mat, THREE.LineSegments));
        });
        scene.add(axes);
        return axes
      },

      _onColorsChanged: function() {
        if(['#000', '#000000'].includes(this.colors.secondary)) {
          this.classList.add('dark-mode');
          this.classList.remove('light-mode');
        } else {
          this.classList.add('light-mode');
          this.classList.remove('dark-mode');
        }
      },
      _addToScene: function(geometry) {
        this.scene.add(geometry);
      },
      _renderScene: function() {
        requestAnimationFrame(this._renderScene.bind(this));
        // BGL.controls.update();
        this.renderer.render(this.scene, this.camera);
      },
      _cameraZoom: function() {
        return window.innerWidth / window.innerHeight;
      },

      ready: function() {
        this.triggerRender = true;
        this._renderScene();
      }
    });
  </script>
</dom-module>
